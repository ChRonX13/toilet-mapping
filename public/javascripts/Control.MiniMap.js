L.Control.MiniMap=L.Control.extend({options:{position:"bottomright",toggleDisplay:false,zoomLevelOffset:-5,zoomLevelFixed:false,zoomAnimation:false,autoToggleDisplay:false,width:150,height:150,aimingRectOptions:{color:"#ff7800",weight:1,clickable:false},shadowRectOptions:{color:"#000000",weight:1,clickable:false,opacity:0,fillOpacity:0}},hideText:"Hide MiniMap",showText:"Show MiniMap",initialize:function(e,t){L.Util.setOptions(this,t);this.options.aimingRectOptions.clickable=false;this.options.shadowRectOptions.clickable=false;this._layer=e},onAdd:function(e){this._mainMap=e;this._container=L.DomUtil.create("div","leaflet-control-minimap");this._container.style.width=this.options.width+"px";this._container.style.height=this.options.height+"px";L.DomEvent.disableClickPropagation(this._container);L.DomEvent.on(this._container,"mousewheel",L.DomEvent.stopPropagation);this._miniMap=new L.Map(this._container,{attributionControl:false,zoomControl:false,zoomAnimation:this.options.zoomAnimation,autoToggleDisplay:this.options.autoToggleDisplay,touchZoom:!this.options.zoomLevelFixed,scrollWheelZoom:!this.options.zoomLevelFixed,doubleClickZoom:!this.options.zoomLevelFixed,boxZoom:!this.options.zoomLevelFixed,crs:e.options.crs});this._miniMap.addLayer(this._layer);this._mainMapMoving=false;this._miniMapMoving=false;this._userToggledDisplay=false;this._minimized=false;if(this.options.toggleDisplay){this._addToggleButton()}this._miniMap.whenReady(L.Util.bind(function(){this._aimingRect=L.rectangle(this._mainMap.getBounds(),this.options.aimingRectOptions).addTo(this._miniMap);this._shadowRect=L.rectangle(this._mainMap.getBounds(),this.options.shadowRectOptions).addTo(this._miniMap);this._mainMap.on("moveend",this._onMainMapMoved,this);this._mainMap.on("move",this._onMainMapMoving,this);this._miniMap.on("movestart",this._onMiniMapMoveStarted,this);this._miniMap.on("move",this._onMiniMapMoving,this);this._miniMap.on("moveend",this._onMiniMapMoved,this)},this));return this._container},addTo:function(e){L.Control.prototype.addTo.call(this,e);this._miniMap.setView(this._mainMap.getCenter(),this._decideZoom(true));this._setDisplay(this._decideMinimized());return this},onRemove:function(e){this._mainMap.off("moveend",this._onMainMapMoved,this);this._mainMap.off("move",this._onMainMapMoving,this);this._miniMap.off("moveend",this._onMiniMapMoved,this);this._miniMap.removeLayer(this._layer)},_addToggleButton:function(){this._toggleDisplayButton=this.options.toggleDisplay?this._createButton("",this.hideText,"leaflet-control-minimap-toggle-display",this._container,this._toggleDisplayButtonClicked,this):undefined},_createButton:function(e,t,n,r,i,s){var o=L.DomUtil.create("a",n,r);o.innerHTML=e;o.href="#";o.title=t;var u=L.DomEvent.stopPropagation;L.DomEvent.on(o,"click",u).on(o,"mousedown",u).on(o,"dblclick",u).on(o,"click",L.DomEvent.preventDefault).on(o,"click",i,s);return o},_toggleDisplayButtonClicked:function(){this._userToggledDisplay=true;if(!this._minimized){this._minimize();this._toggleDisplayButton.title=this.showText}else{this._restore();this._toggleDisplayButton.title=this.hideText}},_setDisplay:function(e){if(e!=this._minimized){if(!this._minimized){this._minimize()}else{this._restore()}}},_minimize:function(){if(this.options.toggleDisplay){this._container.style.width="19px";this._container.style.height="19px";this._toggleDisplayButton.className+=" minimized"}else{this._container.style.display="none"}this._minimized=true},_restore:function(){if(this.options.toggleDisplay){this._container.style.width=this.options.width+"px";this._container.style.height=this.options.height+"px";this._toggleDisplayButton.className=this._toggleDisplayButton.className.replace(/(?:^|\s)minimized(?!\S)/g,"")}else{this._container.style.display="block"}this._minimized=false},_onMainMapMoved:function(e){if(!this._miniMapMoving){this._mainMapMoving=true;this._miniMap.setView(this._mainMap.getCenter(),this._decideZoom(true));this._setDisplay(this._decideMinimized())}else{this._miniMapMoving=false}this._aimingRect.setBounds(this._mainMap.getBounds())},_onMainMapMoving:function(e){this._aimingRect.setBounds(this._mainMap.getBounds())},_onMiniMapMoveStarted:function(e){var t=this._aimingRect.getBounds();var n=this._miniMap.latLngToContainerPoint(t.getSouthWest());var r=this._miniMap.latLngToContainerPoint(t.getNorthEast());this._lastAimingRectPosition={sw:n,ne:r}},_onMiniMapMoving:function(e){if(!this._mainMapMoving&&this._lastAimingRectPosition){this._shadowRect.setBounds(new L.LatLngBounds(this._miniMap.containerPointToLatLng(this._lastAimingRectPosition.sw),this._miniMap.containerPointToLatLng(this._lastAimingRectPosition.ne)));this._shadowRect.setStyle({opacity:1,fillOpacity:.3})}},_onMiniMapMoved:function(e){if(!this._mainMapMoving){this._miniMapMoving=true;this._mainMap.setView(this._miniMap.getCenter(),this._decideZoom(false));this._shadowRect.setStyle({opacity:0,fillOpacity:0})}else{this._mainMapMoving=false}},_decideZoom:function(e){if(!this.options.zoomLevelFixed){if(e)return this._mainMap.getZoom()+this.options.zoomLevelOffset;else{var t=this._miniMap.getZoom()-this._mainMap.getZoom();var n=this._miniMap.getZoom()-this.options.zoomLevelOffset;var r;if(t>this.options.zoomLevelOffset&&this._mainMap.getZoom()<this._miniMap.getMinZoom()-this.options.zoomLevelOffset){if(this._miniMap.getZoom()>this._lastMiniMapZoom){r=this._mainMap.getZoom()+1;this._miniMap.setZoom(this._miniMap.getZoom()-1)}else{r=this._mainMap.getZoom()}}else{r=n}this._lastMiniMapZoom=this._miniMap.getZoom();return r}}else{if(e)return this.options.zoomLevelFixed;else return this._mainMap.getZoom()}},_decideMinimized:function(){if(this._userToggledDisplay){return this._minimized}if(this.options.autoToggleDisplay){if(this._mainMap.getBounds().contains(this._miniMap.getBounds())){return true}return false}return this._minimized}});L.Map.mergeOptions({miniMapControl:false});L.Map.addInitHook(function(){if(this.options.miniMapControl){this.miniMapControl=(new L.Control.MiniMap).addTo(this)}});L.control.minimap=function(e){return new L.Control.MiniMap(e)}